# src/safeway_guardian/core/elemental_balance.py
"""
ðŸ”° SAFEWAY GUARDIAN - SG QUANTUM OS
Created by: Nicolas E. Santiago, Saitama, Japan, Nov. 7, 2025
Powered by DEEPSEEK AI RESEARCH TECHNOLOGY

ELEMENTAL BALANCE MONITOR - Five Elements Harmony
Maintains optimal balance between Wood, Fire, Earth, Metal, Water
"""

class ElementalBalanceMonitor:
    """
    ðŸ”° SAFEWAY GUARDIAN Elemental Balance System
    Prevents any single element from dominating the system
    Implements traditional five elements theory in quantum computing
    """
    
    def __init__(self):
        self.operator = "Nicolas E. Santiago"
        self.optimal_ratios = {
            'wood': 0.20,    # 20% growth and expansion
            'fire': 0.15,    # 15% transformation and response
            'earth': 0.25,   # 25% stability and foundation  
            'metal': 0.20,   # 20% structure and security
            'water': 0.20    # 20% flow and adaptation
        }
        
        self.elemental_cycles = {
            'generation': ['wood', 'fire', 'earth', 'metal', 'water'],  # Creation cycle
            'control': ['wood', 'earth', 'water', 'fire', 'metal']      # Control cycle
        }
        
    def maintain_balance(self, system_metrics: Dict[str, Any]) -> Dict[str, Any]:
        """
        Maintain harmony between the five elements
        
        Args:
            system_metrics: Current system state metrics
            
        Returns:
            Balance adjustments applied
        """
        current_ratios = self._calculate_current_ratios(system_metrics)
        imbalance = self._detect_imbalance(current_ratios)
        
        corrections = {}
        if imbalance:
            self._log_imbalance_warning(imbalance)
            corrections = self._apply_elemental_correction(imbalance)
            
        return {
            'timestamp': system_metrics['timestamp'],
            'current_ratios': current_ratios,
            'optimal_ratios': self.optimal_ratios,
            'imbalance_detected': bool(imbalance),
            'corrections_applied': corrections,
            'balanced_by': self.operator,
            'technology': "DEEPSEEK AI RESEARCH TECHNOLOGY"
        }
    
    def _detect_imbalance(self, current_ratios: Dict[str, float]) -> Dict[str, Any]:
        """
        Detect elemental imbalances using five elements theory
        
        Returns imbalance analysis with correction strategy
        """
        imbalances = []
        
        # Check for elemental excess
        for element, ratio in current_ratios.items():
            optimal = self.optimal_ratios[element]
            
            if ratio > optimal * 1.3:  # 30% excess
                imbalances.append({
                    'type': 'excess',
                    'element': element,
                    'current': ratio,
                    'optimal': optimal,
                    'correction': self._get_control_element(element)
                })
            elif ratio < optimal * 0.7:  # 30% deficit
                imbalances.append({
                    'type': 'deficit', 
                    'element': element,
                    'current': ratio,
                    'optimal': optimal,
                    'correction': self._get_generation_element(element)
                })
                
        return imbalances if imbalances else None
    
    def _get_control_element(self, excess_element: str) -> str:
        """
        Five Elements Control Cycle (Ke Cycle)
        Wood controls Earth â†’ Earth controls Water â†’ Water controls Fire â†’ Fire controls Metal â†’ Metal controls Wood
        """
        control_map = {
            'wood': 'metal',  # Metal axes chop wood
            'fire': 'water',  # Water extinguishes fire
            'earth': 'wood',  # Wood penetrates earth (roots)
            'metal': 'fire',  # Fire melts metal
            'water': 'earth'  # Earth dams water
        }
        return control_map.get(excess_element, 'earth')  # Default to stability
    
    def _get_generation_element(self, deficit_element: str) -> str:
        """
        Five Elements Generation Cycle (Sheng Cycle)  
        Wood feeds Fire â†’ Fire creates Earth â†’ Earth bears Metal â†’ Metal collects Water â†’ Water nourishes Wood
        """
        generation_map = {
            'wood': 'water',  # Water nourishes wood
            'fire': 'wood',   # Wood feeds fire
            'earth': 'fire',  # Fire creates earth (ash)
            'metal': 'earth', # Earth bears metal
            'water': 'metal'  # Metal collects water
        }
        return generation_map.get(deficit_element, 'wood')  # Default to growth
